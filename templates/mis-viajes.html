<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransPort - Mi Viaje</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }
    
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 320px;
        height: 100vh;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        overflow-y: auto;
        z-index: 1000;
        color: #1a1a1a;
    }
    
    .header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border-bottom: 2px solid rgba(255,215,0,0.3);
    }

    .header h1 {
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        color: #1a1a1a;
        font-weight: 700;
    }
    
    .viaje-panel {
        margin: 1rem;
        background: rgba(255,215,0,0.15);
        border-radius: 16px;
        padding: 1.2rem;
        border: 2px solid #FFD700;
    }
    
    .conductor-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #FFD700;
    }

    .conductor-avatar {
        width: 55px;
        height: 55px;
        background: linear-gradient(45deg, #333, #555);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffd93d;
        font-size: 1.5rem;
    }

    .conductor-info h3 {
        font-size: 1.1rem;
        color: #1a1a1a;
        margin-bottom: 0.2rem;
    }

    .conductor-vehiculo {
        font-size: 0.85rem;
        color: #666;
    }
    
    .info-row {
        display: flex;
        align-items: flex-start;
        gap: 0.8rem;
        margin-bottom: 0.8rem;
        padding: 0.7rem;
        background: rgba(255,255,255,0.5);
        border-radius: 10px;
        font-size: 0.9rem;
    }
    
    .info-row i {
        width: 20px;
        font-size: 1rem;
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .info-row strong {
        display: block;
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 0.15rem;
    }

    .info-row span {
        color: #1a1a1a;
        font-weight: 600;
    }

    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.7rem;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: capitalize;
    }

    .estado-confirmado { background: #e8f5e9; color: #2e7d32; }
    .estado-en_curso { background: #e3f2fd; color: #1565c0; }
    .estado-aceptada { background: #fff3e0; color: #ef6c00; }
    
    .btn-grande {
        width: 100%;
        padding: 1rem;
        font-size: 0.95rem;
        font-weight: 700;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        margin-bottom: 0.6rem;
    }
    
    .btn-cancelar {
        background: linear-gradient(45deg, #e53935, #c62828);
        color: white;
    }
    
    .btn-cancelar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(229, 57, 53, 0.4);
    }

    .btn-cancelar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: white;
        color: #333;
        border: 2px solid #ddd;
    }

    .btn-secondary:hover {
        background: #f5f5f5;
        border-color: #ccc;
    }

    .btn-whatsapp {
        background: linear-gradient(45deg, #25D366, #128C7E);
        color: white;
    }

    .btn-whatsapp:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
    }

    .btn-llamar {
        background: linear-gradient(45deg, #1e88e5, #1565c0);
        color: white;
    }

    .btn-llamar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
    }
    
    .controls {
        padding: 0 1rem 1rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
    }
    
    .empty-state i {
        font-size: 3rem;
        color: #ddd;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #999;
        margin-bottom: 1rem;
    }

    .empty-state .btn-buscar {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
    }
    
    #map {
        position: fixed;
        top: 0;
        left: 320px;
        right: 0;
        bottom: 0;
        z-index: 1;
    }
    
    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            height: auto;
            max-height: 45vh;
            position: relative;
        }
        
        #map {
            position: relative;
            left: 0;
            top: 0;
            height: 55vh;
        }

        body {
            overflow-y: auto;
        }
    }
</style>
</head>

<body>
    <div class="sidebar">
        <div class="header">
            <h1><i class="fas fa-car-side"></i> Mi Viaje</h1>
        </div>

        {% if viajes and viajes|length > 0 %}
            {% set viaje = viajes[0] %}
            
            {# Datos robustos #}
            {% set origen_nombre = (viaje.origen.get('nombre') if viaje.origen is mapping else viaje.origen) %}
            {% set destino_nombre = (viaje.destino.get('nombre') if viaje.destino is mapping else viaje.destino) %}
            {% set tel_raw = (viaje.conductor_telefono or '') %}
            {% set tel_digits = tel_raw|replace(' ', '')|replace('-', '')|replace('(', '')|replace(')', '')|replace('+', '') %}
            {% set tel_wa = (tel_digits if tel_digits.startswith('51') else ('51' ~ tel_digits)) %}
            {% set tel_ok = (tel_digits|length >= 8) %}

            <div class="viaje-panel">
                <div class="conductor-header">
                    <div class="conductor-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="conductor-info">
                        <h3>{{ viaje.conductor_nombre or 'Conductor asignado' }}</h3>
                        <div class="conductor-vehiculo">
                            {{ viaje.conductor_modelo or 'Auto' }}
                            {% if viaje.conductor_color %} ({{ viaje.conductor_color }}){% endif %}
                            ‚Ä¢ {{ viaje.conductor_placa or '---' }}
                        </div>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-map-marker-alt" style="color: #4caf50;"></i>
                    <div>
                        <strong>Recoger en:</strong>
                        <span>{{ origen_nombre }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-flag-checkered" style="color: #f44336;"></i>
                    <div>
                        <strong>Destino:</strong>
                        <span>{{ destino_nombre }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-coins" style="color: #ffd93d;"></i>
                    <div>
                        <strong>Tarifa:</strong>
                        <span>S/. {{ "%.2f"|format(viaje.precio_acordado if viaje.precio_acordado else viaje.precio_estandar) }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-road" style="color: #666;"></i>
                    <div>
                        <strong>Distancia total:</strong>
                        <span>{{ "%.1f"|format(viaje.distancia) if viaje.distancia else '--' }} km</span>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-info-circle" style="color: #ff9800;"></i>
                    <div>
                        <strong>Estado:</strong>
                        {% set est = (viaje.estado or '').lower() %}
                        <span class="badge-estado {% if est == 'confirmado' %}estado-confirmado{% elif est == 'en_curso' %}estado-en_curso{% else %}estado-aceptada{% endif %}">
                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                            {{ (viaje.estado or 'pendiente').replace('_',' ') }}
                        </span>
                    </div>
                </div>

                {% if viaje.conductor_telefono %}
                <div class="info-row">
                    <i class="fas fa-phone" style="color: #1e88e5;"></i>
                    <div>
                        <strong>Tel√©fono:</strong>
                        <span>{{ viaje.conductor_telefono }}</span>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="controls">
                {% if tel_ok %}
                <a href="https://wa.me/{{ tel_wa }}?text=Hola, soy tu pasajero del viaje TransPort" 
                   target="_blank" class="btn-grande btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
                
                {% endif %}

                {% set est = (viaje.estado or '').lower() %}
                {% set puede_cancelar = est in ['pendiente', 'aceptada', 'confirmado'] %}
                {% if puede_cancelar %}
                <button id="btnCancelar" class="btn-grande btn-cancelar" onclick="cancelarViaje({{ viaje.id }})">
                    <i class="fas fa-ban"></i> Cancelar viaje
                </button>
                {% endif %}

                <a href="/buscar-viaje" class="btn-grande btn-secondary">
                    <i class="fas fa-search"></i> Buscar otro viaje
                </a>
                <a href="/dashboard" class="btn-grande btn-secondary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>

        {% else %}
            <div class="empty-state">
                <i class="fas fa-route"></i>
                <p>No tienes un viaje activo</p>
                <a href="/buscar-viaje" class="btn-buscar">
                    <i class="fas fa-search"></i> Buscar viaje
                </a>
                <div style="margin-top: 1rem;">
                    <a href="/dashboard" style="color: #666; text-decoration: none;">
                        <i class="fas fa-arrow-left"></i> Volver al Dashboard
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- @ts-nocheck -->
<script>
    // @ts-nocheck
    /* eslint-disable */
    let map;
    let origenMarker;
    let destinoMarker;
    let rutaPolyline;
    let intervaloVerificacion = null;
    let viajeIdActual = null;

    // Datos del viaje desde Jinja
    const viajeData = JSON.parse('{{ viaje_json | safe }}' || '{"id": null}');

    const origenIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
    });

    const destinoIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
    });

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        
        if (viajeData.id) {
            viajeIdActual = viajeData.id;
            dibujarRuta();
            iniciarVerificacion();
        }
    });

    function initMap() {
        const limaCenter = [-12.0464, -77.0428];
        map = L.map('map').setView(limaCenter, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);
    }

    async function dibujarRuta() {
        if (!viajeData.id) return;

        const origen = viajeData.origen;
        const destino = viajeData.destino;

        // Marcador origen (verde)
        origenMarker = L.marker([origen.lat, origen.lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #4caf50; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map).bindPopup(`<b>üìç Punto de recojo</b><br>${origen.nombre}`);

        // Marcador destino (rojo)
        destinoMarker = L.marker([destino.lat, destino.lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #f44336; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.3);"><i class="fas fa-flag-checkered"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map).bindPopup(`<b>üèÅ Destino</b><br>${destino.nombre}`);

        // Dibujar ruta con OSRM
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.routes && data.routes[0]) {
                const rutaGeoJSON = data.routes[0].geometry;
                rutaPolyline = L.geoJSON(rutaGeoJSON, {
                    style: {
                        color: '#4caf50',
                        weight: 6,
                        opacity: 0.8
                    }
                }).addTo(map);

                // Ajustar vista
                const bounds = L.latLngBounds([
                    [origen.lat, origen.lng],
                    [destino.lat, destino.lng]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        } catch (error) {
            console.error('Error obteniendo ruta OSRM:', error);
            // Fallback: l√≠nea recta
            rutaPolyline = L.polyline([
                [origen.lat, origen.lng],
                [destino.lat, destino.lng]
            ], { color: '#4caf50', weight: 4 }).addTo(map);

            map.fitBounds(rutaPolyline.getBounds(), { padding: [50, 50] });
        }
    }

    function iniciarVerificacion() {
        if (intervaloVerificacion) return;

        intervaloVerificacion = setInterval(async () => {
            try {
                const res = await fetch('/api/pasajero/mis-solicitudes', {
                    credentials: 'same-origin'
                });

                if (!res.ok) throw new Error('Error al verificar');

                const solicitudes = await res.json();

                const miViaje = solicitudes.find(s => 
                    s.id === viajeIdActual && 
                    ['pendiente', 'aceptada', 'confirmado', 'en_curso'].includes(s.estado)
                );

                if (!miViaje) {
                    console.log('‚ö†Ô∏è Viaje cancelado o finalizado');
                    clearInterval(intervaloVerificacion);
                    alert('üö´ El conductor cancel√≥ el viaje o fue finalizado.');
                    window.top.location.href = '/buscar-viaje';
                }

            } catch (error) {
                console.error('Error verificando viaje:', error);
            }
        }, 5000);
    }

    window.addEventListener('beforeunload', () => {
        if (intervaloVerificacion) {
            clearInterval(intervaloVerificacion);
        }
    });

    async function cancelarViaje(viajeId) {
        if (!confirm("¬øCancelar el viaje?")) return;

        const btn = document.getElementById("btnCancelar");
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelando...';
        }

        try {
            const res = await fetch("/api/pasajero/cancelar-viaje", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({ solicitud_id: viajeId, motivo: "Cancelado por el pasajero" })
            });

            const data = await res.json().catch(() => ({}));

            if (res.ok && data.ok) {
                if (intervaloVerificacion) {
                    clearInterval(intervaloVerificacion);
                }
                alert("‚úÖ Viaje cancelado exitosamente.");
                window.top.location.href = "/buscar-viaje";
                return;
            }

            alert("‚ùå No se pudo cancelar: " + (data.error || ("HTTP " + res.status)));
        } catch (e) {
            console.error(e);
            alert("‚ùå Error al cancelar el viaje");
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-ban"></i> Cancelar viaje';
            }
        }
    }
</script>

</body>
</html>
