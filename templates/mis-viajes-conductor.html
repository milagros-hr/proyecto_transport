<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransPort - Mis Viajes</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }
    
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 350px;
        height: 100vh;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        overflow-y: auto;
        z-index: 1000;
        color: white;
    }
    
    .header {
        padding: 2rem 1.5rem;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border-bottom: 2px solid rgba(255,215,0,0.3);
    }

    .header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        color: #1a1a1a;
        font-weight: 700;
    }

    .sidebar {
        color: #1a1a1a;
    }

    .viaje-activo-panel h3 {
        color: #1a1a1a;
    }

    .info-row {
        color: #1a1a1a;
    }

    .empty-state {
        color: #6c757d;
    }

    .btn-primary {
        color: #1a1a1a;
    }
    
    .header p {
        font-size: 0.9rem;
        color: #333;
        opacity: 0.9;
    }
    
    .viaje-activo-panel {
        margin: 1.5rem;
        background: rgba(255,215,0,0.15);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        border: 2px solid #FFD700;
    }
    
    .viaje-activo-panel h3 {
        font-size: 1.3rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #FFD700;
        color: #FFD700;
    }
    
    .info-row {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.8rem;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        font-size: 0.95rem;
    }
    
    .info-row i {
        width: 20px;
        font-size: 1.1rem;
        opacity: 0.9;
        flex-shrink: 0;
    }
    
    .info-row strong {
        display: block;
        margin-bottom: 0.2rem;
        font-size: 0.85rem;
        opacity: 0.8;
    }
    
    #distanciaAlPasajero {
        background: rgba(255, 215, 0, 0.2);
        border-left: 3px solid #FFD700;
    }
    
    .btn-grande {
        width: 100%;
        padding: 1.2rem;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.8rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btn-grande.iniciar {
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #1a1a1a;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        font-weight: 800;
    }
    
    .btn-grande.iniciar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(255, 215, 0, 0.7);
        background: linear-gradient(45deg, #FFA500, #FFD700);
    }
    
    .btn-grande.finalizar {
        background: linear-gradient(45deg, #FFD700, #FFC107);
        color: #1a1a1a;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        font-weight: 800;
    }
    
    .btn-grande.finalizar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(255, 215, 0, 0.7);
        background: linear-gradient(45deg, #FFC107, #FFD700);
    }
    
    .btn-cancelar {
        background: rgba(244, 67, 54, 0.8);
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
    }
    
    .btn-cancelar:hover {
        background: #f44336;
    }
    
    .controls {
        padding: 1rem 1.5rem;
    }
    
    .btn-primary {
        display: block;
        width: 100%;
        padding: 1rem;
        background: rgba(255,215,0,0.2);
        border: 2px solid #dfc84b;
        border-radius: 10px;
        color: #2f2a11;
        font-weight: 600;
        text-decoration: none;
        text-align: center;
        margin-bottom: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: rgba(255,215,0,0.3);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    
    .btn-primary i {
        margin-right: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        opacity: 0.8;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    #map {
        position: fixed;
        top: 0;
        left: 350px;
        right: 0;
        bottom: 0;
        z-index: 1;
    }
    
    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            height: auto;
            max-height: 50vh;
        }
        
        #map {
            left: 0;
            top: 50vh;
        }
    }
</style>

</head>

<body>
    <div class="sidebar">
        <div class="header">
            <h1><i class="fas fa-route"></i> Viaje en Curso</h1>
        </div>

        <div id="viajeActivo" style="display: none; padding: 1.5rem;"></div>

        <div id="panelEspera" style="display: none; margin: 1.5rem; background: #fff3cd; padding: 1rem; border-radius: 12px; border-left: 5px solid #ff9800;">
            <h3 style="font-size: 1rem; color: #856404; margin-bottom: 0.8rem;">
                <i class="fas fa-clock fa-spin"></i> Esperando confirmaci√≥n...
            </h3>
            <div id="listaEspera" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
        </div>

        <div id="sinViaje" style="padding: 2rem; text-align: center;">
            <i class="fas fa-inbox" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
            <p style="color: #999;">No tienes viajes activos</p>
            <a href="/crear-ruta" class="btn btn-primary" style="margin-top: 1rem; display: inline-block; text-decoration: none;">
                <i class="fas fa-search"></i> Buscar solicitudes
            </a>
        </div>

        <div class="controls">
            <a href="/crear-ruta" class="btn-primary" style="text-decoration: none; text-align: center;">
                <i class="fas fa-plus"></i> Buscar m√°s viajes
            </a>
            <a href="/dashboard" class="btn-primary" style="text-decoration: none; text-align: center;">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let conductorMarker;
    let pasajeroMarker;
    let destinoMarker;
    let rutaPolyline;
    let rutaAlPasajeroPolyline; 
    let viajeActual = null;
    let watchId = null;
    let intervaloActualizacion = null;
    let ubicacionConductor = null;
    let ultimoViajeId = null;

    const carIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097150.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40]
    });

    const passengerIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png',
        iconSize: [35, 35],
        iconAnchor: [17, 35]
    });

    const destinoIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [35, 35],
        iconAnchor: [17, 35]
    });

    // ‚úÖ INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Iniciando aplicaci√≥n conductor...');
        initMap();
        iniciarGPS();
        cargarViajeActivo(); // Primera carga
    });

    function initMap() {
        const limaCenter = [-12.0464, -77.0428];
        map = L.map('map').setView(limaCenter, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        console.log('üó∫Ô∏è Mapa inicializado');
    }

    // ‚úÖ FUNCI√ìN: Limpiar completamente la vista
    function limpiarVista() {
        console.log('üßπ Limpiando vista...');
        
        if (pasajeroMarker) {
            map.removeLayer(pasajeroMarker);
            pasajeroMarker = null;
        }
        if (destinoMarker) {
            map.removeLayer(destinoMarker);
            destinoMarker = null;
        }
        if (rutaPolyline) {
            map.removeLayer(rutaPolyline);
            rutaPolyline = null;
        }
        if (rutaAlPasajeroPolyline) {
            map.removeLayer(rutaAlPasajeroPolyline);
            rutaAlPasajeroPolyline = null;
        }

        document.getElementById('sinViaje').style.display = 'block';
        document.getElementById('viajeActivo').style.display = 'none';
        document.getElementById('panelEspera').style.display = 'none';

        viajeActual = null;
        ultimoViajeId = null;
    }

    function iniciarGPS() {
        if (!navigator.geolocation) {
            console.log('‚ùå GPS no disponible');
            return;
        }

        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                actualizarPosicionConductor(lat, lng);
            },
            (error) => {
                console.error("‚ùå Error GPS:", error);
                actualizarPosicionConductor(-12.0464, -77.0428);
            },
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
        );
    }

    function actualizarPosicionConductor(lat, lng) {
        ubicacionConductor = { lat, lng };
        
        if (conductorMarker) {
            conductorMarker.setLatLng([lat, lng]);
        } else {
            conductorMarker = L.marker([lat, lng], { icon: carIcon })
                .addTo(map)
                .bindPopup('<b>üöó Tu ubicaci√≥n</b>');
            map.setView([lat, lng], 15);
        }

        if (viajeActual && viajeActual.origen) {
            const distancia = calcularDistancia(
                lat, lng,
                viajeActual.origen.lat, viajeActual.origen.lng
            );
            actualizarDistanciaUI(distancia);
            dibujarRutaAlPasajero();
        }
    }

    // ‚úÖ CARGAR VIAJE ACTIVO (CORREGIDO)
    async function cargarViajeActivo() {
        console.log('üîÑ Verificando viajes activos...');
        
        try {
            const res = await fetch('/api/conductor/mis-viajes-activos', {
                credentials: 'same-origin'
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const viajes = await res.json();
            console.log('üì¶ Respuesta API:', viajes);

            // ‚úÖ DETECTAR CANCELACI√ìN DEL PASAJERO
            const cancelacion = viajes.find(v =>
                v.estado === 'cancelado_pasajero' || v.tipo === 'cancelacion'
            );

            if (cancelacion) {
                console.log('‚ö†Ô∏è CANCELACI√ìN DETECTADA:', cancelacion);
                
                // Detener el polling primero
                if (intervaloActualizacion) {
                    clearInterval(intervaloActualizacion);
                    intervaloActualizacion = null;
                }
                
                // Marcar como vista para que no vuelva a aparecer
                await fetch('/api/conductor/marcar-cancelacion-vista', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ solicitud_id: cancelacion.id })
                });
                
                alert('‚ö†Ô∏è EL PASAJERO HA CANCELADO EL VIAJE\n\nRuta: ' + (cancelacion.origen?.nombre || 'Origen') + ' ‚Üí ' + (cancelacion.destino?.nombre || 'Destino') + '\n\nSer√°s redirigido para buscar nuevas solicitudes.');
                window.location.href = '/crear-ruta';
                return;
            }

            const nuevoViaje = viajes.find(v => 
                v.estado === 'confirmado' || v.estado === 'en_curso'
            );

            // ‚úÖ DETECCI√ìN DE CANCELACI√ìN
            if (ultimoViajeId !== null && !nuevoViaje) {
                console.log('‚ö†Ô∏è VIAJE CANCELADO - Redirigiendo...');
                
                if (intervaloActualizacion) {
                    clearInterval(intervaloActualizacion);
                    intervaloActualizacion = null;
                }

                alert('üö´ El pasajero cancel√≥ el viaje.');
                window.location.href = '/crear-ruta';
                return;
            }

            // ‚úÖ NO HAY VIAJE
            if (!nuevoViaje) {
                console.log('‚ÑπÔ∏è Sin viajes activos');
                limpiarVista();
                
                if (intervaloActualizacion) {
                    clearInterval(intervaloActualizacion);
                    intervaloActualizacion = null;
                }
                return;
            }

            // ‚úÖ HAY VIAJE ACTIVO
            console.log('‚úÖ Viaje activo encontrado:', nuevoViaje);
            viajeActual = nuevoViaje;
            ultimoViajeId = viajeActual.id;

            renderizarViajeActivo();
            await dibujarRutaReal();

            // ‚úÖ INICIAR POLLING (solo si no existe)
            if (!intervaloActualizacion) {
                console.log('‚è∞ Iniciando polling cada 3 segundos');
                intervaloActualizacion = setInterval(cargarViajeActivo, 3000);
            }

        } catch (error) {
            console.error('‚ùå Error cargando viaje:', error);
            limpiarVista();
        }
    }

    function renderizarViajeActivo() {
        document.getElementById('sinViaje').style.display = 'none';
        document.getElementById('viajeActivo').style.display = 'block';

        const estado = viajeActual.estado;
        const esConfirmado = estado === 'confirmado';
        const esEnCurso = estado === 'en_curso';

        document.getElementById('viajeActivo').innerHTML = `
            <div class="viaje-activo-panel">
                <h3>
                    <i class="fas fa-user-circle"></i> 
                    ${viajeActual.pasajero_nombre || 'Pasajero'}
                </h3>

                <div class="info-row">
                    <i class="fas fa-map-marker-alt" style="color: #4caf50;"></i>
                    <div>
                        <strong>Recoger en:</strong>
                        ${viajeActual.origen.nombre}
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-flag-checkered" style="color: #f44336;"></i>
                    <div>
                        <strong>Destino:</strong>
                        ${viajeActual.destino.nombre}
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-dollar-sign" style="color: #ffd93d;"></i>
                    <div>
                        <strong>Tarifa:</strong>
                        S/. ${viajeActual.precio_acordado.toFixed(2)}
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-road"></i>
                    <div>
                        <strong>Distancia total:</strong>
                        ${viajeActual.distancia.toFixed(1)} km
                    </div>
                </div>

                <div class="info-row" id="distanciaAlPasajero">
                    <i class="fas fa-location-arrow"></i>
                    <div>
                        <strong>Distancia al punto de recojo:</strong>
                        <span>Calculando...</span>
                    </div>
                </div>

                <div class="info-row">
                    <i class="fas fa-phone"></i>
                    <div>
                        <a href="tel:${viajeActual.pasajero_telefono}" 
                           style="color: #1a1a1a; text-decoration: none; font-weight: 600;">
                            ${viajeActual.pasajero_telefono || 'N/A'}
                        </a>
                    </div>
                </div>
            </div>

            <div style="padding: 0 1.5rem;">
                ${esConfirmado ? `
                    <button class="btn-grande iniciar" onclick="iniciarViaje()">
                        <i class="fas fa-play-circle"></i>
                        Iniciar Viaje
                    </button>
                    
                    <button class="btn-grande" onclick="navegarRutaCompletaGoogle()" 
                        style="background: white; color: #333; border: 2px solid #4285F4; margin-bottom: 0.5rem;">
                        <i class="fab fa-google" style="color: #4285F4;"></i>
                        Ver Ruta Completa (Google Maps)
                    </button>
                ` : ''}

                ${esEnCurso ? `
                    <button class="btn-grande finalizar" onclick="finalizarViaje()">
                        <i class="fas fa-flag-checkered"></i>
                        Finalizar Viaje
                    </button>
                    
                    <button class="btn-grande" onclick="navegarADestino()" 
                            style="background: linear-gradient(45deg, #34a853, #4caf50); color: white; margin-bottom: 0.5rem;">
                        <i class="fas fa-map-marked-alt"></i>
                        Navegar a Destino (Google Maps)
                    </button>
                ` : ''}

                <button class="btn-grande btn-cancelar" onclick="cancelarViaje()">
                    <i class="fas fa-times"></i> Cancelar Viaje
                </button>
            </div>
        `;
    }

    async function dibujarRutaAlPasajero() {
        if (!ubicacionConductor || !viajeActual || !viajeActual.origen) return;

        if (rutaAlPasajeroPolyline) {
            map.removeLayer(rutaAlPasajeroPolyline);
        }

        const origen = ubicacionConductor;
        const destino = viajeActual.origen;

        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.routes && data.routes[0]) {
                const rutaGeoJSON = data.routes[0].geometry;
                rutaAlPasajeroPolyline = L.geoJSON(rutaGeoJSON, {
                    style: {
                        color: '#FFD700',
                        weight: 6,
                        opacity: 0.9,
                        dashArray: '10, 5'
                    }
                }).addTo(map);
            }
        } catch (error) {
            console.error('Error dibujando ruta OSRM:', error);
        }
    }

    async function dibujarRutaReal() {
        if (!viajeActual) return;

        const origen = viajeActual.origen;
        const destino = viajeActual.destino;

        if (pasajeroMarker) map.removeLayer(pasajeroMarker);
        if (destinoMarker) map.removeLayer(destinoMarker);
        if (rutaPolyline) map.removeLayer(rutaPolyline);

        pasajeroMarker = L.marker([origen.lat, origen.lng], { icon: passengerIcon })
            .addTo(map)
            .bindPopup(`<b>üìç Recoger aqu√≠</b><br>${origen.nombre}`);

        destinoMarker = L.marker([destino.lat, destino.lng], { icon: destinoIcon })
            .addTo(map)
            .bindPopup(`<b>üèÅ Destino</b><br>${destino.nombre}`);

        if (ubicacionConductor) {
            await dibujarRutaAlPasajero();
        }

        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${origen.lng},${origen.lat};${destino.lng},${destino.lat}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.routes && data.routes[0]) {
                const rutaGeoJSON = data.routes[0].geometry;
                rutaPolyline = L.geoJSON(rutaGeoJSON, {
                    style: {
                        color: '#4caf50',
                        weight: 5,
                        opacity: 0.7
                    }
                }).addTo(map);

                const bounds = L.latLngBounds([]);
                if (ubicacionConductor) bounds.extend([ubicacionConductor.lat, ubicacionConductor.lng]);
                bounds.extend([origen.lat, origen.lng]);
                bounds.extend([destino.lat, destino.lng]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        } catch (error) {
            console.error('Error obteniendo ruta OSRM:', error);
        }
    }

    function actualizarDistanciaUI(distanciaKm) {
        const elem = document.getElementById('distanciaAlPasajero');
        if (!elem) return;

        const tiempoEstimado = Math.ceil(distanciaKm * 2.5);
        elem.innerHTML = `
            <i class="fas fa-location-arrow"></i>
            <div>
                <strong>Distancia al punto de recojo:</strong>
                ${distanciaKm.toFixed(2)} km (~${tiempoEstimado} min)
            </div>
        `;
    }

    async function iniciarViaje() {
        if (!confirm('¬øIniciar este viaje? El pasajero recibir√° notificaci√≥n.')) return;

        try {
            const res = await fetch('/api/conductor/iniciar-viaje', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ solicitud_id: viajeActual.id })
            });

            const data = await res.json();

            if (data.ok) {
                alert('‚úÖ Viaje iniciado correctamente');
                await cargarViajeActivo();
            } else {
                alert('‚ùå ' + (data.error || 'Error al iniciar'));
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
            alert('Error al iniciar el viaje');
        }
    }

    async function finalizarViaje() {
        if (!confirm('¬øFinalizar este viaje?')) return;

        try {
            const res = await fetch('/api/conductor/finalizar-viaje', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ solicitud_id: viajeActual.id })
            });

            const data = await res.json();

            if (data.ok) {
                alert('‚úÖ ¬°Viaje completado exitosamente!');
                window.location.href = '/crear-ruta';
            } else {
                alert('‚ùå ' + (data.error || 'Error'));
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
            alert('Error al finalizar el viaje');
        }
    }

    async function cancelarViaje() {
        const motivo = prompt('¬øPor qu√© cancelas este viaje? (opcional)');
        if (motivo === null) return;

        try {
            const res = await fetch('/api/conductor/cancelar-viaje', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ 
                    solicitud_id: viajeActual.id,
                    motivo: motivo
                })
            });

            const data = await res.json();

            if (data.ok) {
                alert('Viaje cancelado correctamente');
                window.location.href = '/crear-ruta';
            } else {
                alert('‚ùå ' + (data.error || 'Error'));
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
            alert('Error al cancelar');
        }
    }

    function calcularDistancia(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function navegarRutaCompletaGoogle() {
        if (!ubicacionConductor || !viajeActual) {
            alert("Faltan datos del viaje.");
            return;
        }

        const url = `https://www.google.com/maps/dir/?api=1&origin=${ubicacionConductor.lat},${ubicacionConductor.lng}&destination=${viajeActual.destino.lat},${viajeActual.destino.lng}&waypoints=${viajeActual.origen.lat},${viajeActual.origen.lng}&travelmode=driving`;
        window.open(url, '_blank');
    }

    function navegarADestino() {
        if (!viajeActual || !viajeActual.destino) {
            alert('No hay destino disponible');
            return;
        }

        const url = `https://www.google.com/maps/dir/?api=1&destination=${viajeActual.destino.lat},${viajeActual.destino.lng}&travelmode=driving`;
        window.open(url, '_blank');
    }

    // ‚úÖ LIMPIAR AL SALIR
    window.addEventListener('beforeunload', () => {
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
    });
</script>

</body>
</html>